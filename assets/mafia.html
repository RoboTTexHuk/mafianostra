<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="x-poe-datastore-behavior" content="local_only">
  <title>Mafia Nostra Clubbook</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        container: { center: true, padding: { DEFAULT: '1rem', md: '1.25rem', lg: '1.5rem' } },
        extend: {
          colors: {
            'brand-black': '#121212',
            'brand-gray': '#1E1E1E',
            'brand-gold': { light: '#FDE08D', DEFAULT: '#DF9B2D', dark: '#AB7A22' },
            'brand-text': '#E0E0E0',
            'brand-text-muted': '#9A9A9A'
          },
          screens: { xs: '380px', ipad: '768px', ipadl: '1024px' }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&amp;family=Cinzel:wght@600;700&amp;display=swap">
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; -webkit-overflow-scrolling: touch; }

    .font-cinzel { font-family: 'Cinzel', serif; }
    .gold-gradient-text { background: linear-gradient(180deg,#FDE08D 0%,#DF9B2D 100%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; color:transparent; }
    .gold-gradient-bg{ background:linear-gradient(180deg,#FDE08D 0%,#DF9B2D 100%); }
    .tab-active{ color:#FDE08D!important; border-bottom-color:#DF9B2D!important; }

    .input{ width:100%; background:#1E1E1E; color:#E0E0E0; border:1.5px solid rgba(223,155,45,.45); border-radius:.9rem; padding:.8rem .95rem; outline:none; transition:.15s; box-shadow:inset 0 1px 0 rgba(255,255,255,.04); appearance:none; -webkit-appearance:none; font-size:16px; line-height:1.25; }
    select.input{ padding-right:2.2rem; }
    .input:focus{ border-color:#DF9B2D; box-shadow:0 0 0 3px rgba(223,155,45,.15), inset 0 1px 0 rgba(255,255,255,.05); background:#1C1C1C; }
    .input::placeholder{ color:#9A9A9A; }

    .icon-left{ position:absolute; left:.7rem; top:50%; transform:translateY(-50%); color:#C9AE78; font-size:.95rem; pointer-events:none; width:1.2rem; height:1.2rem; border-radius:.4rem; background:rgba(255,255,255,.06); display:inline-flex; align-items:center; justify-content:center; }
    .input-with-icon{ padding-left:2.6rem; }
    .select-wrap{ position:relative; }
    .select-wrap::after{ content:'‚ñæ'; position:absolute; right:.7rem; top:50%; transform:translateY(-50%); color:#C9AE78; pointer-events:none; }

    .btn-gold{ background:#DF9B2D; color:#121212; font-weight:700; padding:.72rem 1rem; border-radius:.75rem; font-size:16px; }
    .btn-ghost{ background:#1E1E1E; color:#E0E0E0; border:1px solid rgba(223,155,45,.35); padding:.72rem 1rem; border-radius:.75rem; font-size:16px; }

    header, nav, .tab-panel, .card, .btn-gold, .btn-ghost { transform: translateZ(0); backface-visibility: hidden; }

    .toolbar{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media(min-width:480px){ .toolbar{ grid-template-columns:repeat(3,1fr); } }

    .three-panels{ display:grid; grid-template-columns:1fr; gap:.75rem; }
    @media(min-width:480px){ .three-panels{ grid-template-columns:repeat(3,1fr); } }

    /* Reports stacked lists */
    .report-list{ display:flex; flex-direction:column; gap:.6rem; }
    .report-row{ display:flex; flex-direction:column; gap:.25rem; padding:.35rem .5rem; border:1px solid rgba(223,155,45,.18); border-radius:.6rem; background:rgba(0,0,0,.25); }
    .report-row .label{ color:#9A9A9A; }

    #export-overlay{ backdrop-filter: blur(4px); }
  </style>
  <script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body class="bg-brand-black text-brand-text">
<div id="app" class="min-h-screen max-w-[960px] mx-auto">
  <!-- Header -->
  <header class="w-full bg-brand-gray/60 backdrop-blur-md sticky top-0 z-50 border-b border-brand-gold/20">
    <div class="px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2 min-w-0">
        <button id="menu-btn" class="shrink-0 w-8 h-8 rounded-md border border-brand-gold/40 flex items-center justify-center text-brand-gold" title="Open Settings">‚â°</button>
        <h1 class="font-cinzel text-xl md:text-2xl tracking-wider gold-gradient-text font-bold truncate">MAFIA NOSTRA</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-onboarding" class="btn-ghost hidden xs:inline-flex">Help</button>
        <button id="btn-settings" class="w-8 h-8 rounded-md border border-brand-gold/40 flex items-center justify-center text-brand-gold" title="Settings">‚öôÔ∏è</button>
      </div>
    </div>
    <nav class="bg-brand-gray">
      <div class="flex overflow-x-auto px-2 md:px-6 gap-1">
        <button onclick="changeTab(0)" class="tab-button py-3 px-3 xs:px-4 text-xs xs:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold tab-active">CRM</button>
        <button onclick="changeTab(1)" class="tab-button py-3 px-3 xs:px-4 text-xs xs:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">FINANCES</button>
        <button onclick="changeTab(2)" class="tab-button py-3 px-3 xs:px-4 text-xs xs:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">DRESS CODE</button>
        <button onclick="changeTab(3)" class="tab-button py-3 px-3 xs:px-4 text-xs xs:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">MARKET</button>
        <button onclick="changeTab(4)" class="tab-button py-3 px-3 xs:px-4 text-xs xs:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">EVENTS</button>
        <button onclick="changeTab(5)" class="tab-button py-3 px-3 xs:px-4 text-xs xs:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">REPORTS</button>
      </div>
    </nav>
  </header>

  <main class="px-4 md:px-6 pb-28 pt-4">
    <!-- CRM -->
    <section id="crm-tab" class="tab-panel space-y-4">
      <div class="relative">
        <span class="icon-left">üîé</span>
        <input id="member-search" type="text" inputmode="search" placeholder="Search members..." class="input input-with-icon">
        <div class="flex items-center gap-2 mt-3 flex-wrap">
          <button class="btn-gold" onclick="openMemberModal()">+ Add Member</button>
          <button class="btn-ghost" onclick="exportMembersCSV()">Export CSV</button>
          <label class="btn-ghost cursor-pointer">
            Import CSV
            <input id="members-import" type="file" accept=".csv,text/csv" class="hidden" onchange="importMembersCSV(this.files[0])">
          </label>
        </div>
      </div>

      <div class="grid grid-cols-1 xs:grid-cols-3 gap-2">
        <div class="relative select-wrap">
          <span class="icon-left">üë§</span>
          <select id="filter-role" class="input input-with-icon" onchange="applyMemberFilters()">
            <option value="">All Roles</option>
            <option value="DON">Don</option>
            <option value="CONSIGLIERE">Consigliere</option>
            <option value="ASSOCIATO">Associato</option>
          </select>
        </div>
        <div class="relative select-wrap">
          <span class="icon-left">üí≥</span>
          <select id="filter-dues" class="input input-with-icon" onchange="applyMemberFilters()">
            <option value="">All Dues</option>
            <option value="Paid">Paid</option>
            <option value="Overdue">Overdue</option>
          </select>
        </div>
        <div class="relative select-wrap">
          <span class="icon-left">‚ÜïÔ∏è</span>
          <select id="sort-by" class="input input-with-icon" onchange="applyMemberFilters()">
            <option value="name">Sort: Name</option>
            <option value="attendance">Sort: Attendance</option>
            <option value="loyalty">Sort: Loyalty</option>
          </select>
        </div>
      </div>

      <div id="members-list" class="space-y-3"></div>
    </section>

    <!-- Finances -->
    <section id="finances-tab" class="tab-panel hidden space-y-4">
      <div class="bg-brand-gray p-4 xs:p-6 rounded-xl border border-brand-gold/30">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="min-w-[200px]">
            <h3 class="font-cinzel text-sm text-brand-text-muted tracking-widest">CLUB BALANCE</h3>
            <p id="budget-amount" class="text-3xl xs:text-4xl font-bold gold-gradient-text my-2">$0</p>
          </div>
          <div class="flex items-stretch gap-2 w-full xs:w-auto">
            <div class="relative flex-1 min-w-[140px]">
              <span class="icon-left">üéØ</span>
              <input id="goal-target" type="number" inputmode="decimal" class="input input-with-icon w-full" placeholder="Goal, $">
            </div>
            <div class="relative select-wrap flex-1 min-w-[140px]">
              <span class="icon-left">üìÜ</span>
              <select id="goal-period" class="input input-with-icon w-full">
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>

          </div>
          <button class="btn-gold shrink-0" onclick="saveBudgetGoal()">Save goal</button>
        </div>
        <div class="mt-4">
          <div class="h-2 w-full bg-brand-black rounded-full">
            <div id="budget-progress" class="h-2 gold-gradient-bg rounded-full" style="width: 0%;"></div>
          </div>
          <div class="mt-2 text-xs text-brand-text-muted flex items-center flex-wrap gap-2">
            <span id="goal-label" class="whitespace-nowrap">No goal set</span>
            <span id="goal-warning" class="text-red-400 font-semibold hidden">Warning: expense limit exceeded!</span>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
          <div class="bg-brand-black/50 rounded p-2">
            <p class="text-brand-text-muted">Income</p>
            <p id="income-sum" class="font-bold text-green-400">+$0</p>
          </div>
          <div class="bg-brand-black/50 rounded p-2">
            <p class="text-brand-text-muted">Expenses</p>
            <p id="expense-sum" class="font-bold text-red-500">-$0</p>
          </div>
          <div class="bg-brand-black/50 rounded p-2">
            <p class="text-brand-text-muted">Net</p>
            <p id="net-sum" class="font-bold gold-gradient-text">$0</p>
          </div>
        </div>
      </div>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Add Transaction</h3>
        <div class="grid grid-cols-1 xs:grid-cols-2 gap-3">
          <div class="relative">
            <span class="icon-left">üè∑Ô∏è</span>
            <input id="tx-title" class="input input-with-icon" placeholder="Title (e.g., Venue Rental)">
          </div>
          <div class="relative">
            <span class="icon-left">$</span>
            <input id="tx-amount" type="number" inputmode="decimal" step="0.01" class="input input-with-icon" placeholder="Amount (e.g., 15000)">
          </div>
          <div class="relative select-wrap">
            <span class="icon-left">‚ÜîÔ∏è</span>
            <select id="tx-type" class="input input-with-icon">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
          <div class="relative select-wrap">
            <span class="icon-left">üè∑Ô∏è</span>
            <select id="tx-category" class="input input-with-icon">
              <option value="rent">Rent</option>
              <option value="dues">Dues</option>
              <option value="attire">Attire</option>
              <option value="prizes">Prizes</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="relative">
            <span class="icon-left">üìÖ</span>
            <input id="tx-date" type="date" class="input input-with-icon">
          </div>
          <div class="relative select-wrap">
            <span class="icon-left">üîÅ</span>
            <select id="tx-repeat" class="input input-with-icon">
              <option value="none">No repeat</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
        </div>
        <button class="btn-gold" onclick="addTransaction()">+ Add</button>
      </div>

      <div class="three-panels">
        <div class="relative select-wrap">
          <span class="icon-left">üè∑Ô∏è</span>
          <select id="tx-filter-category" class="input input-with-icon" onchange="renderTransactions()">
            <option value="">All categories</option>
            <option value="rent">Rent</option>
            <option value="dues">Dues</option>
            <option value="attire">Attire</option>
            <option value="prizes">Prizes</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="relative select-wrap">
          <span class="icon-left">‚ÜîÔ∏è</span>
          <select id="tx-filter-type" class="input input-with-icon" onchange="renderTransactions()">
            <option value="">All types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
        <div class="relative">
          <span class="icon-left">üîé</span>
          <input id="tx-filter-search" class="input input-with-icon" placeholder="Search title" oninput="renderTransactions()">
        </div>
      </div>

      <h3 class="font-cinzel text-lg gold-gradient-text pt-2">Recent Transactions</h3>
      <div id="transactions-list" class="space-y-3"></div>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <div class="flex items-center justify-between">
          <h3 class="font-cinzel text-lg gold-gradient-text">Recurring Templates</h3>
          <div class="flex gap-2">
            <button class="btn-ghost" onclick="runRecurringNow()">Apply Now</button>
            <button class="btn-ghost" onclick="addDefaultRecurring()">Add Monthly Dues</button>
          </div>
        </div>
        <div id="recurring-list" class="space-y-2"></div>
      </div>
    </section>

    <!-- Dress Code -->
    <section id="dresscode-tab" class="tab-panel hidden space-y-4">
      <h2 class="font-cinzel text-xl gold-gradient-text">Style Guide: 1930s‚Äì1950s</h2>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Create Look</h3>
        <div class="relative">
          <span class="icon-left">‚úçÔ∏è</span>
          <input id="look-title" class="input input-with-icon" placeholder="Look name (e.g., The Don's Attire)">
        </div>
        <div class="relative">
          <span class="icon-left">üìù</span>
          <textarea id="look-notes" rows="3" class="input input-with-icon" placeholder="Notes: occasion, season, tips"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="relative"><span class="icon-left">‚ñ™Ô∏è</span><input id="look-item-1" class="input input-with-icon" placeholder="Item 1"></div>
          <div class="relative"><span class="icon-left">‚ñ™Ô∏è</span><input id="look-item-2" class="input input-with-icon" placeholder="Item 2"></div>
          <div class="relative"><span class="icon-left">‚ñ™Ô∏è</span><input id="look-item-3" class="input input-with-icon" placeholder="Item 3"></div>
          <div class="relative"><span class="icon-left">‚ñ™Ô∏è</span><input id="look-item-4" class="input input-with-icon" placeholder="Item 4"></div>
        </div>
        <button class="btn-gold" onclick="addLook()">+ Add Look</button>
      </div>

      <div id="preset-looks" class="space-y-4">
        <div class="bg-brand-gray rounded-xl overflow-hidden border border-brand-gold/30">
          <div class="h-40 w-full flex items-center justify-center bg-brand-black/60">
            <svg width="100%" height="100%" viewBox="0 0 600 200" preserveAspectRatio="xMidYMid slice">
              <rect width="600" height="200" fill="#1a1a1a"></rect>
              <text x="50%" y="50%" fill="#DF9B2D" text-anchor="middle" font-family="Cinzel, serif" font-size="28">The Don's Attire</text>
            </svg>
          </div>
          <div class="p-4">
            <h3 class="font-cinzel text-lg font-bold text-white">The Don's Attire</h3>
            <p class="text-sm text-brand-text-muted mb-3">Essential for formal gatherings.</p>
            <ul class="text-sm space-y-2">
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Double-breasted pinstripe suit</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Black fedora</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-text-muted mr-3"></span>Silk pocket square</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Polished oxfords</li>
            </ul>
          </div>
        </div>
        <div class="bg-brand-gray rounded-xl overflow-hidden border border-brand-gold/30">
          <div class="h-40 w-full flex items-center justify-center bg-brand-black/60">
            <svg width="100%" height="100%" viewBox="0 0 600 200" preserveAspectRatio="xMidYMid slice">
              <rect width="600" height="200" fill="#1a1a1a"></rect>
              <text x="50%" y="50%" fill="#DF9B2D" text-anchor="middle" font-family="Cinzel, serif" font-size="28">Associate's Casual</text>
            </svg>
          </div>
          <div class="p-4">
            <h3 class="font-cinzel text-lg font-bold text-white">Associate's Casual</h3>
            <p class="text-sm text-brand-text-muted mb-3">For day-to-day business.</p>
            <ul class="text-sm space-y-2">
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>High-waisted trousers</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-text-muted mr-3"></span>Silk camp-collar shirt</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Leather suspenders</li>
            </ul>
          </div>
        </div>
      </div>

      <h3 class="font-cinzel text-lg gold-gradient-text">Your Looks</h3>
      <div id="looks-list" class="space-y-3"></div>
    </section>

    <!-- Marketplace -->
    <section id="marketplace-tab" class="tab-panel hidden space-y-4">
      <h2 class="font-cinzel text-xl gold-gradient-text">Approved Ateliers</h2>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Add Vendor</h3>
        <div class="relative"><span class="icon-left">üè™</span><input id="vendor-name" class="input input-with-icon" placeholder="Vendor name"></div>
        <div class="relative"><span class="icon-left">üßµ</span><input id="vendor-service" class="input input-with-icon" placeholder="Services"></div>
        <div class="relative"><span class="icon-left">üîó</span><input id="vendor-link" class="input input-with-icon" placeholder="Link (optional)"></div>
        <button class="btn-gold" onclick="addVendor()">+ Add Vendor</button>
      </div>

      <div id="vendors-list" class="space-y-3">
        <div class="flex items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/30 gap-4">
          <div class="w-20 h-20 rounded-lg bg-brand-black/40 flex items-center justify-center text-brand-gold text-2xl">‚úÇÔ∏è</div>
          <div class="flex-1 min-w-0">
            <h3 class="font-bold text-white truncate">Giovanni's Fine Tailoring</h3>
            <p class="text-sm text-brand-text-muted">Bespoke Suits &amp; Restoration</p>
            <span class="text-xs text-brand-gold hover:underline cursor-pointer" onclick="openVendor('Giovanni's Fine Tailoring')">View Services ‚Üí</span>
          </div>
        </div>
        <div class="flex items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/30 gap-4">
          <div class="w-20 h-20 rounded-lg bg-brand-black/40 flex items-center justify-center text-brand-gold text-2xl">üëû</div>
          <div class="flex-1 min-w-0">
            <h3 class="font-bold text-white truncate">Milano Shoe Shine &amp; Repair</h3>
            <p class="text-sm text-brand-text-muted">Leather Care &amp; Restoration</p>
            <span class="text-xs text-brand-gold hover:underline cursor-pointer" onclick="openVendor('Milano Shoe Shine &amp; Repair')">View Services ‚Üí</span>
          </div>
        </div>
      </div>
      <div id="vendors-dynamic"></div>
    </section>

    <!-- Events -->
    <section id="events-tab" class="tab-panel hidden space-y-4">
      <h2 class="font-cinzel text-xl gold-gradient-text">Events</h2>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Create Event</h3>
        <div class="grid grid-cols-1 xs:grid-cols-2 gap-3">
          <div class="relative"><span class="icon-left">üè∑Ô∏è</span><input id="ev-title" class="input input-with-icon" placeholder="Title (e.g., Club Night)"></div>
          <div class="relative"><span class="icon-left">üìÖ</span><input id="ev-date" type="datetime-local" class="input input-with-icon"></div>
          <div class="relative"><span class="icon-left">üìç</span><input id="ev-place" class="input input-with-icon" placeholder="Place"></div>
          <div class="relative select-wrap">
            <span class="icon-left">üîî</span>
            <select id="ev-remind" class="input input-with-icon">
              <option value="none">No reminder</option>
              <option value="ics">Add to calendar (.ics)</option>
            </select>
          </div>
        </div>
        <div class="relative">
          <span class="icon-left">üë•</span>
          <input id="ev-invitees" class="input input-with-icon" placeholder="Invitees (comma-separated) or leave blank for all members">
        </div>
        <button class="btn-gold" onclick="addEvent()">+ Add Event</button>
      </div>

      <div id="events-list" class="space-y-3"></div>
    </section>

    <!-- Reports -->
    <section id="reports-tab" class="tab-panel hidden space-y-4">
      <h2 class="font-cinzel text-xl gold-gradient-text">Reports &amp; Analytics</h2>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <div class="toolbar">
          <div class="relative select-wrap">
            <span class="icon-left">üìÜ</span>
            <select id="rep-range" class="input input-with-icon" onchange="renderReports()">
              <option value="3m">3 months</option>
              <option value="6m">6 months</option>
              <option value="12m" selected="">12 months</option>
              <option value="all">All time</option>
            </select>
          </div>
          <div class="relative select-wrap">
            <span class="icon-left">üè∑Ô∏è</span>
            <select id="rep-category" class="input input-with-icon" onchange="renderReports()">
              <option value="">All categories</option>
              <option value="rent">Rent</option>
              <option value="dues">Dues</option>
              <option value="attire">Attire</option>
              <option value="prizes">Prizes</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="relative select-wrap">
            <span class="icon-left">‚ÜîÔ∏è</span>
            <select id="rep-type" class="input input-with-icon" onchange="renderReports()">
              <option value="">Income + Expense</option>
              <option value="income">Income only</option>
              <option value="expense">Expense only</option>
            </select>
          </div>
        </div>

        <div class="bg-brand-black/50 rounded-xl p-3 border border-brand-gold/20">
          <h4 class="font-cinzel text-sm text-brand-text-muted mb-2">Balance Line</h4>
          <div class="w-full overflow-hidden rounded-lg border border-brand-gold/10">
            <canvas id="chart-balance" class="block w-full" height="160"></canvas>
          </div>
        </div>

        <!-- Stacked vertical lists -->
        <div class="grid grid-cols-1 gap-3">
          <div class="bg-brand-black/50 rounded-xl p-3 border border-brand-gold/20">
            <h4 class="font-cinzel text-sm text-brand-text-muted mb-2">By months</h4>
            <div id="rep-monthly" class="report-list"></div>
          </div>
          <div class="bg-brand-black/50 rounded-xl p-3 border border-brand-gold/20">
            <h4 class="font-cinzel text-sm text-brand-text-muted mb-2">By categories</h4>
            <div id="rep-cats" class="report-list"></div>
          </div>
          <div class="bg-brand-black/50 rounded-xl p-3 border border-brand-gold/20">
            <h4 class="font-cinzel text-sm text-brand-text-muted mb-2">Totals</h4>
            <div id="rep-totals" class="report-list"></div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 no-print">
          <button class="btn-ghost" onclick="exportReportCSV()">Export CSV</button>
          <button class="btn-ghost" onclick="exportReportJSON()">Export JSON</button>
          <button class="btn-gold" onclick="safePrint()">Print</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Side panel -->
  <aside id="side-panel" class="fixed top-0 right-0 h-full w-[92%] max-w-md bg-brand-gray border-l border-brand-gold/30 shadow-xl translate-x-full transition-transform duration-200 z-50">
    <div class="p-4 flex items-center justify-between border-b border-brand-gold/20">
      <h3 class="font-cinzel text-lg gold-gradient-text">Settings</h3>
      <button class="text-brand-text-muted hover:text-brand-gold" onclick="closeSidePanel()">‚úï</button>
    </div>
    <div class="p-4 space-y-4 overflow-y-auto" style="max-height: calc(100% - 60px)">
      <div class="bg-brand-black/40 border border-brand-gold/20 rounded-xl p-3">
        <h4 class="font-cinzel text-sm text-brand-text-muted">Localization</h4>
        <div class="mt-2 relative select-wrap">
          <span class="icon-left">üåê</span>
          <select id="opt-locale" class="input input-with-icon">
            <option value="en">English</option>
          </select>
        </div>
      </div>
      <div class="bg-brand-black/40 border border-brand-gold/20 rounded-xl p-3">
        <h4 class="font-cinzel text-sm text-brand-text-muted">Format</h4>
        <div class="grid grid-cols-1 xs:grid-cols-2 gap-2 mt-2">
          <div class="relative select-wrap">
            <span class="icon-left">üí±</span>
            <select id="opt-currency" class="input input-with-icon">
              <option value="USD">$ USD</option>
              <option value="EUR">‚Ç¨ EUR</option>
              <option value="RUB">‚ÇΩ RUB</option>
            </select>
          </div>
          <div class="relative select-wrap">
            <span class="icon-left">üé®</span>
            <select id="opt-theme" class="input input-with-icon">
              <option value="auto">Auto</option>
              <option value="dark" selected="">Dark</option>
              <option value="light">Light</option>
            </select>
          </div>
        </div>
      </div>
      <div class="bg-brand-black/40 border border-brand-gold/20 rounded-xl p-3">
        <h4 class="font-cinzel text-sm text-brand-text-muted">Backup</h4>
        <div class="flex gap-2 mt-2 flex-wrap">
          <button class="btn-ghost" onclick="exportBackup()">Export JSON</button>
          <label class="btn-ghost cursor-pointer">
            Import JSON
            <input id="backup-import" type="file" accept="application/json,.json" class="hidden" onchange="importBackup(this.files[0])">
          </label>
          <button class="btn-ghost" onclick="clearAllData()">Clear All</button>
        </div>
      </div>
      <div class="bg-brand-black/40 border border-brand-gold/20 rounded-xl p-3">
        <h4 class="font-cinzel text-sm text-brand-text-muted">Privacy</h4>
        <p class="text-xs text-brand-text-muted mt-1">
          All data is stored locally on your device. Nothing is sent to servers. You can export or delete your data at any time.
        </p>
      </div>
    </div>
  </aside>

  <!-- Member Modal -->
  <div id="member-modal" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-brand-gray w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl border border-brand-gold/30 p-4">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-cinzel text-lg gold-gradient-text">Member</h3>
        <button class="text-brand-text-muted hover:text-brand-gold" onclick="closeMemberModal()">‚úï</button>
      </div>
      <div class="space-y-3">
        <div class="relative"><span class="icon-left">ü™™</span><input id="m-name" class="input input-with-icon" placeholder="Full name"></div>
        <div class="relative select-wrap"><span class="icon-left">‚ôî</span>
          <select id="m-role" class="input input-with-icon">
            <option value="DON">Don</option>
            <option value="CONSIGLIERE">Consigliere</option>
            <option value="ASSOCIATO">Associato</option>
          </select>
        </div>
        <div class="relative select-wrap"><span class="icon-left">üíµ</span>
          <select id="m-dues" class="input input-with-icon">
            <option value="Paid">Dues: Paid</option>
            <option value="Overdue">Dues: Overdue</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="relative"><span class="icon-left">‚úÖ</span><input id="m-att" type="number" inputmode="numeric" min="0" max="100" class="input input-with-icon" placeholder="Attendance %"></div>
          <div class="relative"><span class="icon-left">‚≠ê</span><input id="m-loy" type="number" inputmode="numeric" min="0" max="5" class="input input-with-icon" placeholder="Loyalty 0-5"></div>
        </div>
        <div class="relative"><span class="icon-left">üñºÔ∏è</span><input id="m-avatar" class="input input-with-icon" placeholder="Avatar URL (optional)"></div>
        <div class="relative"><span class="icon-left">üìù</span><input id="m-notes" class="input input-with-icon" placeholder="Notes (contacts, comments)"></div>
        <div class="relative"><span class="icon-left">üè∑Ô∏è</span><input id="m-tags" class="input input-with-icon" placeholder="Tags (comma-separated)"></div>
      </div>
      <div class="flex justify-between items-center mt-4">
        <button class="btn-ghost" onclick="deleteMember()">Delete</button>
        <button class="btn-gold" onclick="saveMember()">Save</button>
      </div>
    </div>
  </div>

  <!-- Onboarding -->
  <div id="onboarding" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
    <div class="bg-brand-gray w-[92%] max-w-lg rounded-2xl border border-brand-gold/30 p-4">
      <div class="flex justify-between items-center">
        <h3 class="font-cinzel text-lg gold-gradient-text">Welcome</h3>
        <button class="text-brand-text-muted hover:text-brand-gold" onclick="endOnboarding()">Skip</button>
      </div>
      <div class="mt-3 space-y-3" id="onboarding-steps"></div>
      <div class="flex justify-between items-center mt-4">
        <button class="btn-ghost" id="ob-prev" onclick="onboardingPrev()">Back</button>
        <button class="btn-gold" id="ob-next" onclick="onboardingNext()">Next</button>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tip hidden fixed z-40 bg-brand-gray border border-brand-gold/35 text-sm text-brand-text p-3 rounded-xl max-w-xs"></div>

  <!-- Export overlay Return -->
  <div id="export-overlay" class="fixed inset-0 hidden items-center justify-center z-[60] bg-black/60">
    <button class="btn-gold" onclick="hideExportOverlay()">Return</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-brand-gray border border-brand-gold/30 text-brand-text px-4 py-2 rounded-lg hidden z-40"></div>
</div>

<script>
  // SafeStorage
  const SafeStorage = (() => {
    let memoryStore = {};
    const hasLocal = (() => { try { const k = '__t'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; } catch(e){ return false; }})();
    const getItem = (k)=> hasLocal? localStorage.getItem(k) : (Object.prototype.hasOwnProperty.call(memoryStore,k)? memoryStore[k]:null);
    const setItem = (k,v)=> hasLocal? localStorage.setItem(k,v) : (memoryStore[k]=v);
    const removeItem = (k)=> hasLocal? localStorage.removeItem(k) : delete memoryStore[k];
    return { getItem, setItem, removeItem, hasLocal };
  })();

  // Tabs
  const tabs = document.querySelectorAll('.tab-button');
  const panels = document.querySelectorAll('.tab-panel');
  function changeTab(i){
    tabs.forEach((t,idx)=>t.classList.toggle('tab-active', idx===i));
    panels.forEach((p,idx)=>p.classList.toggle('hidden', idx!==i));
    SafeStorage.setItem('mn_active_tab', String(i));
    if(i===5) setTimeout(()=>{ renderReports(); fitCanvasWidth(); }, 80);
  }
  const savedTab = Number(SafeStorage.getItem('mn_active_tab'));
  if(!Number.isNaN(savedTab)) setTimeout(()=>changeTab(savedTab), 0);

  // Side panel
  const sidePanel = document.getElementById('side-panel');
  document.getElementById('btn-settings').addEventListener('click', ()=> sidePanel.style.transform='translateX(0)');
  function closeSidePanel(){ sidePanel.style.transform='translateX(100%)'; }

  // Toast
  function showToast(msg, holdMs=2200){
    const t=document.getElementById('toast');
    t.textContent=msg; t.classList.remove('hidden');
    clearTimeout(showToast._t); showToast._t = setTimeout(()=>t.classList.add('hidden'), holdMs);
  }

  // Options
  function getOption(k){ const all = JSON.parse(SafeStorage.getItem('mn_options') || '{}'); return all[k]; }
  function setOption(k,v){ const all = JSON.parse(SafeStorage.getItem('mn_options') || '{}'); all[k]=v; SafeStorage.setItem('mn_options', JSON.stringify(all)); }
  function initOptionsUI(){
    document.getElementById('opt-locale').value = getOption('locale') || 'en';
    document.getElementById('opt-currency').value = getOption('currency') || 'USD';
    document.getElementById('opt-theme').value = getOption('theme') || 'dark';
    document.getElementById('opt-locale').addEventListener('change', e=>{ setOption('locale', e.target.value); showToast('Language saved'); renderAll(); });
    document.getElementById('opt-currency').addEventListener('change', e=>{ setOption('currency', e.target.value); showToast('Currency saved'); renderAll(); });
    document.getElementById('opt-theme').addEventListener('change', e=>{ setOption('theme', e.target.value); applyTheme(); showToast('Theme updated'); });
  }
  function applyTheme(){ const t=getOption('theme')||'dark'; document.documentElement.style.colorScheme = t==='light'?'light':'dark'; }
  applyTheme();

  // Utils
  function escapeHTML(s){ return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function fmtMoney(n, cur=getOption('currency')||'USD'){ const map={USD:'$',EUR:'‚Ç¨',RUB:'‚ÇΩ'}; const sign=n<0?'-':''; return `${sign}${map[cur]||'$'}${Math.abs(n).toLocaleString()}`; }

  // CRM
  const membersListEl=document.getElementById('members-list');
  const searchEl=document.getElementById('member-search');
  const filterRoleEl=document.getElementById('filter-role');
  const filterDuesEl=document.getElementById('filter-dues');
  const sortByEl=document.getElementById('sort-by');
  let members=JSON.parse(SafeStorage.getItem('mn_members')||'[]');
  let editingId=null;

  if(members.length===0){
    members=[
      { id: crypto.randomUUID(), name: "Don Vito Corleone", role: "DON", dues: "Paid", attendance: 100, loyalty: 5, avatar: "", notes:"", tags:["don","founder"] },
      { id: crypto.randomUUID(), name: "Peter Clemenza", role: "ASSOCIATO", dues: "Overdue", attendance: 72, loyalty: 4, avatar: "", notes:"loves cooking", tags:["chef","logistics"] },
      { id: crypto.randomUUID(), name: "Salvatore Tessio", role: "ASSOCIATO", dues: "Paid", attendance: 88, loyalty: 4, avatar: "", notes:"", tags:["organizer"] },
      { id: crypto.randomUUID(), name: "Tom Hagen", role: "CONSIGLIERE", dues: "Paid", attendance: 96, loyalty: 5, avatar: "", notes:"lawyer", tags:["advisor"] }
    ];
    persistMembers();
  }
  function persistMembers(){ SafeStorage.setItem('mn_members', JSON.stringify(members)); }
  function loyaltyStars(n){ const full='‚òÖ', empty='‚òÜ'; return Array.from({length:5},(_,i)=> i<n? `<span class="text-brand-gold">${full}</span>`:`<span class="text-brand-gold/50">${empty}</span>`).join(''); }
  function renderMembers(){
    const q=(searchEl.value||'').toLowerCase(), role=filterRoleEl.value, dues=filterDuesEl.value, sortBy=sortByEl.value;
    let arr=members.filter(m=>{ const text=[m.name,m.notes,(m.tags||[]).join(' ')].join(' ').toLowerCase(); return text.includes(q) && (!role||m.role===role) && (!dues||m.dues===dues); });
    arr.sort((a,b)=> sortBy==='name'?a.name.localeCompare(b.name): sortBy==='attendance'?(b.attendance||0)-(a.attendance||0) : (b.loyalty||0)-(a.loyalty||0));
    membersListEl.innerHTML = arr.map(m=>`
      <div class="card bg-brand-gray p-4 rounded-xl border ${m.role==='DON'?'border-brand-gold/50 shadow-lg shadow-brand-gold/10':'border-brand-gold/30'}">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-full border-2 ${m.role==='DON'?'border-brand-gold':'border-brand-gold-dark'} overflow-hidden bg-brand-black/40 flex items-center justify-center text-brand-gold">
            ${m.avatar? `<img src="${escapeHTML(m.avatar)}" class="w-full h-full object-cover" alt="${escapeHTML(m.name)}">`:'üë§'}
          </div>
          <div class="flex-1 min-w-0">
            <h3 class="text-base md:text-lg font-bold text-white truncate">${escapeHTML(m.name)}</h3>
            <p class="font-cinzel text-xs md:text-sm ${m.role==='DON'?'gold-gradient-text font-semibold':'text-brand-gold'}">${escapeHTML(m.role)}</p>
            <p class="text-[11px] md:text-xs text-brand-text-muted mt-0.5">Dues: <span class="${m.dues==='Paid'?'text-green-400':'text-red-500'} font-semibold">${escapeHTML(m.dues)}</span></p>
            <div class="mt-2 text-[11px] md:text-xs text-brand-text-muted flex justify-between">
              <span>Attendance: ${m.attendance||0}%</span>
              <span>Loyalty: ${loyaltyStars(m.loyalty||0)}</span>
            </div>
            ${m.tags?.length? `<div class="mt-1 flex flex-wrap gap-1 text-[10px]">${m.tags.map(t=>`<span class="px-2 py-0.5 rounded-full bg-brand-black/40 border border-brand-gold/30">${escapeHTML(t)}</span>`).join('')}</div>`:''}
          </div>
          <div class="flex flex-col items-end gap-2 text-sm">
            <button class="text-brand-gold hover:underline" onclick='openMemberModal(${JSON.stringify(m.id)})'>Edit</button>
            <button class="text-red-400 hover:underline" onclick='confirmDelete("${m.id}")'>Remove</button>
          </div>
        </div>
      </div>`).join('');
  }
  function applyMemberFilters(){ renderMembers(); }
  searchEl.addEventListener('input', renderMembers);
  renderMembers();

  // Members CSV
  function exportMembersCSV(){
    const header=['Name','Role','Dues','Attendance','Loyalty','Avatar','Notes','Tags'];
    const rows=members.map(m=>[m.name,m.role,m.dues,m.attendance,m.loyalty,m.avatar||'',m.notes||'',(m.tags||[]).join('|')]);
    const csv=[header,...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadBlob(csv,'members.csv','text/csv;charset=utf-8;'); showExportOverlay();
  }
  function importMembersCSV(file){
    if(!file) return; const r=new FileReader();
    r.onload=()=>{ const text=String(r.result||''); const lines=text.split(/\r?\n/).filter(Boolean); lines.shift();
      lines.forEach(line=>{ const cols=parseCSVLine(line); const [name,role,dues,att,loy,avatar,notes,tags]=cols; if(!name) return;
        members.push({ id:crypto.randomUUID(), name, role:role||'ASSOCIATO', dues:dues||'Paid', attendance:Number(att||0), loyalty:Math.min(5,Math.max(0,Number(loy||0))), avatar:avatar||'', notes:notes||'', tags:(tags?tags.split('|'):[]) });
      }); persistMembers(); renderMembers(); showToast('Members imported'); };
    r.readAsText(file);
  }
  function parseCSVLine(line){ const out=[]; let cur='',q=false; for(let i=0;i<line.length;i++){ const ch=line[i];
    if(ch==='"'){ if(q && line[i+1]==='"'){ cur+='"'; i++; } else q=!q; }
    else if(ch===',' && !q){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out; }

  const modal=document.getElementById('member-modal');
  const mName=document.getElementById('m-name');
  const mRole=document.getElementById('m-role');
  const mDues=document.getElementById('m-dues');
  const mAtt=document.getElementById('m-att');
  const mLoy=document.getElementById('m-loy');
  const mAv=document.getElementById('m-avatar');
  const mNotes=document.getElementById('m-notes');
  const mTags=document.getElementById('m-tags');

  function openMemberModal(id=null){
    editingId=id;
    if(id){ const m=members.find(x=>x.id===id); if(!m) return;
      mName.value=m.name||''; mRole.value=m.role||'ASSOCIATO'; mDues.value=m.dues||'Paid'; mAtt.value=m.attendance??''; mLoy.value=m.loyalty??''; mAv.value=m.avatar||''; mNotes.value=m.notes||''; mTags.value=(m.tags||[]).join(', ');
    } else { mName.value=''; mRole.value='ASSOCIATO'; mDues.value='Paid'; mAtt.value=''; mLoy.value=''; mAv.value=''; mNotes.value=''; mTags.value=''; }
    modal.classList.remove('hidden'); modal.classList.add('flex');
  }
  function closeMemberModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
  function saveMember(){
    const payload={ name:mName.value.trim(), role:mRole.value, dues:mDues.value, attendance:Number(mAtt.value||0), loyalty:Math.min(5,Math.max(0,Number(mLoy.value||0))), avatar:mAv.value.trim(), notes:mNotes.value.trim(), tags:mTags.value.split(',').map(s=>s.trim()).filter(Boolean) };
    if(!payload.name){ showToast('Enter a name'); return; }
    if(editingId){ const i=members.findIndex(x=>x.id===editingId); if(i>=0) members[i]={...members[i],...payload}; showToast('Member updated'); }
    else { members.push({ id:crypto.randomUUID(), ...payload }); showToast('Member added'); }
    persistMembers(); renderMembers(); closeMemberModal();
  }
  function confirmDelete(id){ if(confirm('Remove this member?')){ members=members.filter(m=>m.id!==id); persistMembers(); renderMembers(); showToast('Member removed'); } }
  function deleteMember(){ if(!editingId){ showToast('Nothing to delete'); return; } confirmDelete(editingId); closeMemberModal(); }

  // Finances
  let transactions=JSON.parse(SafeStorage.getItem('mn_transactions')||'[]');
  if(transactions.length===0){
    transactions=[
      { id: crypto.randomUUID(), title:"Venue Rental: The Venetian", amount:-15000, type:"expense", category:"rent", date:"2025-10-01" },
      { id: crypto.randomUUID(), title:"Membership Dues - Q4", amount:50000, type:"income", category:"dues", date:"2025-09-30" },
      { id: crypto.randomUUID(), title:"Prize Pool Contribution", amount:-5000, type:"expense", category:"prizes", date:"2025-09-28" }
    ];
    persistTransactions();
  }
  function persistTransactions(){ SafeStorage.setItem('mn_transactions', JSON.stringify(transactions)); }

  let budgetGoal=JSON.parse(SafeStorage.getItem('mn_goal')||'null')||{ target:0, period:'monthly' };
  document.getElementById('goal-target').value=budgetGoal.target||'';
  document.getElementById('goal-period').value=budgetGoal.period||'monthly';
  function saveBudgetGoal(){ const t=Number(document.getElementById('goal-target').value||0); const p=document.getElementById('goal-period').value; budgetGoal={target:t,period:p}; SafeStorage.setItem('mn_goal', JSON.stringify(budgetGoal)); showToast('Goal saved'); renderTransactions(); }

  let recurring=JSON.parse(SafeStorage.getItem('mn_recurring')||'[]');
  function persistRecurring(){ SafeStorage.setItem('mn_recurring', JSON.stringify(recurring)); }
  function addDefaultRecurring(){ recurring.push({ id:crypto.randomUUID(), title:'Monthly Dues', amount:10000, type:'income', category:'dues', repeat:'monthly', nextDate: nextFrom(new Date(),'monthly') }); persistRecurring(); renderRecurring(); showToast('Template added'); }
  function nextFrom(d, rep){ const x=new Date(d); if(rep==='monthly') x.setMonth(x.getMonth()+1); else if(rep==='quarterly') x.setMonth(x.getMonth()+3); else if(rep==='yearly') x.setFullYear(x.getFullYear()+1); return x.toISOString().slice(0,10); }
  function runRecurringNow(){ const today=new Date().toISOString().slice(0,10); let count=0; recurring.forEach(r=>{ while(r.nextDate && r.nextDate<=today){ transactions.unshift({ id:crypto.randomUUID(), title:r.title, amount:r.type==='expense'?-Math.abs(r.amount):Math.abs(r.amount), type:r.type, category:r.category||'other', date:r.nextDate }); r.nextDate=nextFrom(r.nextDate, r.repeat); count++; } }); if(count){ persistTransactions(); persistRecurring(); renderTransactions(); showToast(`Generated: ${count}`);} else showToast('No recurring due today'); }
  function renderRecurring(){ const wrap=document.getElementById('recurring-list'); if(!recurring.length){ wrap.innerHTML='<p class="text-sm text-brand-text-muted">No templates yet. They appear when you add a repeating transaction.</p>'; return; } wrap.innerHTML=recurring.map(r=>`<div class="flex items-center justify-between bg-brand-black/40 border border-brand-gold/20 rounded-lg p-2"><div class="text-sm"><div class="font-semibold text-white">${escapeHTML(r.title)}</div><div class="text-brand-text-muted">${r.repeat} ‚Ä¢ ${labelCategory(r.category)} ‚Ä¢ ${fmtMoney(r.type==='expense'?-Math.abs(r.amount):Math.abs(r.amount))}</div><div class="text-brand-text-muted">Next: ${r.nextDate}</div></div><button class="text-red-400 text-sm hover:underline" onclick='removeRecurring("${r.id}")'>Remove</button></div>`).join(''); }
  function removeRecurring(id){ recurring=recurring.filter(x=>x.id!==id); persistRecurring(); renderRecurring(); showToast('Template removed'); }

  function addTransaction(){
    const title=document.getElementById('tx-title').value.trim();
    const amount=Number(document.getElementById('tx-amount').value);
    const type=document.getElementById('tx-type').value;
    const category=document.getElementById('tx-category').value||'other';
    const date=document.getElementById('tx-date').value||new Date().toISOString().slice(0,10);
    const repeat=document.getElementById('tx-repeat').value;
    if(!title || isNaN(amount) || amount===0){ showToast('Enter valid title and amount'); return; }
    const signed= type==='expense' ? -Math.abs(amount) : Math.abs(amount);
    transactions.unshift({ id:crypto.randomUUID(), title, amount:signed, type, category, date }); persistTransactions();
    if(repeat!=='none'){ recurring.push({ id:crypto.randomUUID(), title, amount:Math.abs(amount), type, category, repeat, nextDate: nextFrom(date, repeat)}); persistRecurring(); }
    renderTransactions(); document.getElementById('tx-title').value=''; document.getElementById('tx-amount').value=''; showToast('Transaction added');
  }
  function deleteTransaction(id){ transactions=transactions.filter(t=>t.id!==id); persistTransactions(); renderTransactions(); showToast('Transaction removed'); }
  function filterTransactions(base){ const cat=document.getElementById('tx-filter-category').value; const type=document.getElementById('tx-filter-type').value; const q=(document.getElementById('tx-filter-search').value||'').toLowerCase(); return base.filter(t=>(!cat||t.category===cat)&&(!type||t.type===type)&&t.title.toLowerCase().includes(q)); }
  function renderTransactions(){
    const list=document.getElementById('transactions-list'); const items=filterTransactions(transactions);
    list.innerHTML = items.map(t=>`<div class="flex justify-between items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/20"><div class="min-w-0"><p class="font-bold text-white truncate">${escapeHTML(t.title)}</p><p class="text-xs text-brand-text-muted">${new Date(t.date).toLocaleDateString()} ‚Ä¢ ${labelCategory(t.category)} ‚Ä¢ ${t.type==='income'?'Income':'Expense'}</p></div><div class="flex items-center gap-3"><p class="font-bold ${t.amount>=0?'text-green-400':'text-red-500'}">${t.amount>=0?'+':''}${fmtMoney(Math.abs(t.amount))}</p><button class="text-red-400 hover:underline text-sm" onclick='deleteTransaction("${t.id}")'>Remove</button></div></div>`).join('');
    const income=transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0);
    const expense=transactions.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0);
    const net=income+expense;
    document.getElementById('income-sum').textContent = `+${fmtMoney(income)}`;
    document.getElementById('expense-sum').textContent = `-${fmtMoney(Math.abs(expense))}`;
    document.getElementById('net-sum').textContent = `${fmtMoney(net)}`;
    document.getElementById('budget-amount').textContent = `${fmtMoney(net)}`;
    const label=document.getElementById('goal-label'); const warn=document.getElementById('goal-warning'); const progEl=document.getElementById('budget-progress');
    const target=Number(budgetGoal.target||0);
    if(target>0){ label.textContent=`Goal (${budgetGoal.period}): ${fmtMoney(target)}`; const prog=Math.min(100,Math.max(0,Math.round((Math.max(0,income)/target)*100))); progEl.style.width=`${prog}%`; } else { label.textContent='No goal set'; progEl.style.width='0%'; }
    warn.classList.toggle('hidden', !(target>0 && Math.abs(expense)>target));
    renderRecurring();
  }
  function labelCategory(c){ const map={rent:'Rent',dues:'Dues',attire:'Attire',prizes:'Prizes',other:'Other'}; return map[c]||'Other'; }

  // Reports
  function monthKey(d){ const dt=new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`; }
  function rangeFilter(trans, range){ if(range==='all') return trans.slice(); const now=new Date(); let start=new Date(); if(range==='3m') start.setMonth(now.getMonth()-2,1); if(range==='6m') start.setMonth(now.getMonth()-5,1); if(range==='12m') start.setMonth(now.getMonth()-11,1); start.setHours(0,0,0,0); return trans.filter(t=> new Date(t.date)>=start); }

  function renderReports(){
    const range=document.getElementById('rep-range').value;
    const cat=document.getElementById('rep-category').value;
    const type=document.getElementById('rep-type').value;
    let data=transactions.slice();
    if(cat) data=data.filter(t=>t.category===cat);
    if(type) data=data.filter(t=>t.type===type);
    data=rangeFilter(data, range);

    const months={}, cats={}; let totalIncome=0,totalExpense=0;
    data.forEach(t=>{
      const k=monthKey(t.date); months[k]=months[k]||{income:0,expense:0,net:0};
      if(t.amount>=0){ months[k].income+=t.amount; totalIncome+=t.amount; } else { months[k].expense+=t.amount; totalExpense+=t.amount; }
      months[k].net=months[k].income+months[k].expense;
      const c=t.category||'other'; cats[c]=cats[c]||{income:0,expense:0,net:0}; if(t.amount>=0) cats[c].income+=t.amount; else cats[c].expense+=t.amount; cats[c].net=cats[c].income+cats[c].expense;
    });

    const keys=Object.keys(months).sort();
    drawLineChart('chart-balance', keys, keys.map(k=>months[k].net));

    const mEl=document.getElementById('rep-monthly');
    mEl.innerHTML = keys.length? keys.map(k=>{
      const m=months[k];
      return `<div class="report-row"><div class="label">${k}</div><div><div class="text-green-400">Income: +${fmtMoney(m.income)}</div><div class="text-red-400">Expenses: -${fmtMoney(Math.abs(m.expense))}</div><div class="font-semibold">Net: ${fmtMoney(m.net)}</div></div></div>`;
    }).join(''):'<div class="text-brand-text-muted text-sm">No data</div>';

    const cEl=document.getElementById('rep-cats');
    const cKeys=Object.keys(cats);
    cEl.innerHTML = cKeys.length? cKeys.map(c=>{
      const x=cats[c];
      return `<div class="report-row"><div class="label">${labelCategory(c)}</div><div><div class="text-green-400">Income: +${fmtMoney(x.income)}</div><div class="text-red-400">Expenses: -${fmtMoney(Math.abs(x.expense))}</div><div class="font-semibold">Net: ${fmtMoney(x.net)}</div></div></div>`;
    }).join(''):'<div class="text-brand-text-muted text-sm">No data</div>';

    const tEl=document.getElementById('rep-totals');
    const net=totalIncome+totalExpense;
    tEl.innerHTML = `
      <div class="report-row"><div class="label">Income</div><div class="text-green-400">+${fmtMoney(totalIncome)}</div></div>
      <div class="report-row"><div class="label">Expenses</div><div class="text-red-400">-${fmtMoney(Math.abs(totalExpense))}</div></div>
      <div class="report-row"><div class="label">Net</div><div class="font-semibold">${fmtMoney(net)}</div></div>
    `;
  }

  const lastChart={labels:[],values:[]};
  function fitCanvasWidth(){
    const c=document.getElementById('chart-balance'); if(!c) return;
    const p=c.parentElement; const dpr=window.devicePixelRatio||1; const W=p.clientWidth||320; const H=160;
    c.width=W*dpr; c.height=H*dpr;
    if(lastChart.labels.length) drawLineChart('chart-balance', lastChart.labels, lastChart.values);
  }
  window.addEventListener('resize', ()=>{ if(!document.getElementById('reports-tab').classList.contains('hidden')) fitCanvasWidth(); }, {passive:true});

  function drawLineChart(id, labels, values){
    lastChart.labels=labels.slice(); lastChart.values=values.slice();
    const canvas=document.getElementById(id); const ctx=canvas.getContext('2d');
    const dpr=window.devicePixelRatio||1; const W=canvas.clientWidth||320; const H=canvas.clientHeight||160;
    canvas.width=W*dpr; canvas.height=H*dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,W,H);
    const pad=28, w=W-pad*2, h=H-pad*2;
    if(!values.length){ ctx.fillStyle='#9A9A9A'; ctx.fillText('No data', pad, pad+12); return; }
    const min=Math.min(0,...values), max=Math.max(0,...values), range=(max-min)||1;
    ctx.strokeStyle='rgba(255,255,255,0.06)'; for(let i=0;i<=5;i++){ const y=pad+(h/5)*i; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(pad+w,y); ctx.stroke(); }
    const zeroY=pad+h-((0-min)/range)*h; ctx.strokeStyle='rgba(223,155,45,0.3)'; ctx.beginPath(); ctx.moveTo(pad,zeroY); ctx.lineTo(pad+w,zeroY); ctx.stroke();
    ctx.strokeStyle='#DF9B2D'; ctx.lineWidth=2; ctx.beginPath();
    labels.forEach((_,i)=>{ const x=pad+(w*(i/Math.max(1,labels.length-1))); const y=pad+h-((values[i]-min)/range)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();
    const g=ctx.createLinearGradient(0,pad,0,pad+h); g.addColorStop(0,'rgba(223,155,45,0.35)'); g.addColorStop(1,'rgba(223,155,45,0.02)');
    ctx.lineTo(pad+w,pad+h); ctx.lineTo(pad,pad+h); ctx.closePath(); ctx.fillStyle=g; ctx.fill();
    ctx.fillStyle='#9A9A9A'; ctx.font='12px Inter, system-ui'; const step=Math.ceil(labels.length/6);
    labels.forEach((l,i)=>{ if(i%step===0||i===labels.length-1){ const x=pad+(w*(i/Math.max(1,labels.length-1))); ctx.fillText(l, Math.max(pad, Math.min(x-12, pad+w-24)), pad+h+16); } });
  }

  // Exports
  function exportReportCSV(){
    const range=document.getElementById('rep-range').value;
    const cat=document.getElementById('rep-category').value;
    const type=document.getElementById('rep-type').value;
    let data=transactions.slice();
    if(cat) data=data.filter(t=>t.category===cat);
    if(type) data=data.filter(t=>t.type===type);
    data=rangeFilter(data, range);
    const header=['Date','Title','Type','Category','Amount'];
    const rows=data.map(t=>[t.date,t.title,t.type,t.category,t.amount]);
    const csv=[header,...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    downloadBlob(csv,'report.csv','text/csv;charset=utf-8;'); showExportOverlay();
  }
  function exportReportJSON(){
    const range=document.getElementById('rep-range').value;
    const cat=document.getElementById('rep-category').value;
    const type=document.getElementById('rep-type').value;
    let data=transactions.slice();
    if(cat) data=data.filter(t=>t.category===cat);
    if(type) data=data.filter(t=>t.type===type);
    data=rangeFilter(data, range);
    downloadBlob(JSON.stringify({ range, category:cat, type, items:data },null,2),'report.json','application/json'); showExportOverlay();
  }
  function safePrint(){ if(typeof window.print==='function'){ try{ window.print(); return; }catch(e){} } showToast('Printing not supported. Downloading printable HTML...'); const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Report</title><style>body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;padding:16px;}h1{font-family:Cinzel,serif;}section{margin-bottom:16px;border:1px solid #ccc;border-radius:12px;padding:12px;}table{width:100%;border-collapse:collapse;}td,th{border-bottom:1px solid #ddd;padding:6px 8px;text-align:left;}tfoot td{font-weight:bold;}</style></head><body><h1>Reports & Analytics</h1><section><h2>Transactions</h2><table><thead><tr><th>Date</th><th>Title</th><th>Type</th><th>Category</th><th>Amount</th></tr></thead><tbody>${transactions.map(t=>`<tr><td>${t.date}</td><td>${escapeHTML(t.title)}</td><td>${t.type}</td><td>${labelCategory(t.category)}</td><td>${t.amount}</td></tr>`).join('')}</tbody></table></section></body></html>`; downloadBlob(html,'report.html','text/html;charset=utf-8;'); showExportOverlay(); }

  function downloadBlob(content, filename, type){
    const blob=new Blob([content],{type}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.rel='noopener'; a.style.display='none'; document.body.appendChild(a); a.click();
    requestAnimationFrame(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); });
  }

  // Export overlay
  const exportOverlay=document.getElementById('export-overlay');
  function showExportOverlay(){ exportOverlay.classList.remove('hidden'); exportOverlay.classList.add('flex'); }
  function hideExportOverlay(){ exportOverlay.classList.add('hidden'); exportOverlay.classList.remove('flex'); }

  // Marketplace
  let vendors=JSON.parse(SafeStorage.getItem('mn_vendors')||'[]');
  function persistVendors(){ SafeStorage.setItem('mn_vendors', JSON.stringify(vendors)); }
  function addVendor(){ const name=document.getElementById('vendor-name').value.trim(); const service=document.getElementById('vendor-service').value.trim(); const link=document.getElementById('vendor-link').value.trim(); if(!name||!service){ showToast('Enter vendor name and services'); return; } vendors.unshift({ id:crypto.randomUUID(), name, service, link }); persistVendors(); renderVendors(); document.getElementById('vendor-name').value=''; document.getElementById('vendor-service').value=''; document.getElementById('vendor-link').value=''; showToast('Vendor added'); }
  function removeVendor(id){ vendors=vendors.filter(v=>v.id!==id); persistVendors(); renderVendors(); showToast('Vendor removed'); }
  function openVendor(name){ showToast('Opening '+name+'...'); }
  function renderVendors(){ const c=document.getElementById('vendors-dynamic'); c.innerHTML=vendors.map(v=>`<div class="flex items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/30 gap-4"><div class="w-20 h-20 rounded-lg flex items-center justify-center bg-brand-black/40 text-brand-gold text-2xl">üßµ</div><div class="flex-1 min-w-0"><h3 class="font-bold text-white truncate">${escapeHTML(v.name)}</h3><p class="text-sm text-brand-text-muted">${escapeHTML(v.service)}</p><div class="flex items-center gap-3 mt-1">${v.link?`<a href="${escapeHTML(v.link)}" target="_blank" class="text-xs text-brand-gold hover:underline">Open Link ‚Üó</a>`:''}<button class="text-xs text-red-400 hover:underline" onclick='removeVendor("${v.id}")'>Remove</button></div></div></div>`).join(''); }
  renderVendors();

  // Events
  let events=JSON.parse(SafeStorage.getItem('mn_events')||'[]');
  function persistEvents(){ SafeStorage.setItem('mn_events', JSON.stringify(events)); }
  function addEvent(){
    const title=document.getElementById('ev-title').value.trim();
    const date=document.getElementById('ev-date').value;
    const place=document.getElementById('ev-place').value.trim();
    const remind=document.getElementById('ev-remind').value;
    const raw=document.getElementById('ev-invitees').value.trim();
    const invitees=raw? raw.split(',').map(s=>s.trim()).filter(Boolean) : members.map(m=>m.name);
    if(!title||!date){ showToast('Enter title and date'); return; }
    const id=crypto.randomUUID();
    events.unshift({ id, title, date, place, invitees, rsvp:{}, attendanceMarked:false });
    persistEvents(); renderEvents();
    if(remind==='ics') exportEventICS({ id, title, date, place });
    showToast('Event created'); document.getElementById('ev-title').value=''; document.getElementById('ev-place').value=''; document.getElementById('ev-invitees').value='';
  }
  function exportEventICS(ev){
    const dt=new Date(ev.date); const pad=n=>String(n).padStart(2,'0'); const toICS=d=>`${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}00Z`;
    const start=toICS(dt); const end=toICS(new Date(dt.getTime()+2*60*60*1000));
    const ics=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Mafia Nostra//EN','BEGIN:VEVENT',`UID:${ev.id}@mn.local`,`DTSTAMP:${toICS(new Date())}`,`DTSTART:${start}`,`DTEND:${end}`,`SUMMARY:${ev.title.replace(/,/g,'\\,')}`,`LOCATION:${(ev.place||'').replace(/,/g,'\\,')}`,'END:VEVENT','END:VCALENDAR'].join('\r\n');
    downloadBlob(ics, `${ev.title}.ics`, 'text/calendar;charset=utf-8;'); showExportOverlay();
  }
  function rsvpEvent(id, name, status){ const e=events.find(x=>x.id===id); if(!e) return; e.rsvp[name]=status; persistEvents(); renderEvents(); }
  function markAttendance(id){
    const e=events.find(x=>x.id===id); if(!e||e.attendanceMarked) return;
    const total=(e.invitees||[]).length||1; const present=Object.values(e.rsvp||{}).filter(s=>'yes'===s).length; const ratio=Math.round((present/total)*100);
    members=members.map(m=> e.invitees.includes(m.name)? {...m, attendance: Math.round(m.attendance*0.7 + ratio*0.3)} : m );
    e.attendanceMarked=true; persistMembers(); persistEvents(); renderMembers(); renderEvents(); showToast('Attendance updated');
  }
  function removeEvent(id){ events=events.filter(e=>e.id!==id); persistEvents(); renderEvents(); showToast('Event removed'); }
  function renderEvents(){
    const wrap=document.getElementById('events-list'); if(!events.length){ wrap.innerHTML='<p class="text-sm text-brand-text-muted">No events yet.</p>'; return; }
    wrap.innerHTML=events.map(e=>{
      const inviteesStr=e.invitees.slice(0,3).join(', ')+(e.invitees.length>3?` and ${e.invitees.length-3} more`:'');
      const yes=Object.values(e.rsvp||{}).filter(s=>s==='yes').length;
      const no=Object.values(e.rsvp||{}).filter(s=>s==='no').length;
      const maybe=Object.values(e.rsvp||{}).filter(s=>s==='maybe').length;
      return `<div class="bg-brand-gray rounded-xl border border-brand-gold/30 p-4"><div class="flex justify-between items-start gap-3"><div class="min-w-0"><h4 class="font-cinzel text-lg text-white font-bold truncate">${escapeHTML(e.title)}</h4><p class="text-sm text-brand-text-muted">${new Date(e.date).toLocaleString()} ‚Ä¢ ${escapeHTML(e.place||'')}</p><p class="text-xs text-brand-text-muted mt-1">Invitees: ${escapeHTML(inviteesStr)}</p></div><button class="text-red-400 hover:underline text-sm shrink-0" onclick='removeEvent("${e.id}")'>Remove</button></div><div class="mt-3"><div class="text-xs text-brand-text-muted mb-1">RSVP</div><div class="flex flex-wrap gap-2">${(e.invitees||[]).slice(0,12).map(n=>`<div class="flex items-center gap-2 bg-brand-black/40 border border-brand-gold/20 rounded-lg px-2 py-1"><span class="text-sm">${escapeHTML(n)}</span><div class="flex gap-1"><button class="text-green-400" title="Yes" onclick='rsvpEvent("${e.id}", ${JSON.stringify(n)}, "yes")'>‚úîÔ∏è</button><button class="text-yellow-400" title="Maybe" onclick='rsvpEvent("${e.id}", ${JSON.stringify(n)}, "maybe")'>‚ùî</button><button class="text-red-400" title="No" onclick='rsvpEvent("${e.id}", ${JSON.stringify(n)}, "no")'>‚úñÔ∏è</button></div></div>`).join('')}</div><div class="mt-2 text-xs text-brand-text-muted">Totals: yes ${yes}, no ${no}, maybe ${maybe}</div></div><div class="mt-3 flex items-center gap-2"><button class="btn-ghost" onclick='exportEventICS(${JSON.stringify(e)})'>Export .ics</button><button class="btn-gold ${e.attendanceMarked?'opacity-60 pointer-events-none':''}" onclick='markAttendance("${e.id}")'>Apply Attendance</button></div></div>`;
    }).join('');
  }

  // Backup
  function exportBackup(){ const payload={ members, transactions, looks, vendors, events, recurring, goal: budgetGoal, options: JSON.parse(SafeStorage.getItem('mn_options')||'{}') }; downloadBlob(JSON.stringify(payload,null,2),'clubbook-backup.json','application/json'); showExportOverlay(); }
  function importBackup(file){
    if(!file) return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(String(r.result||'{}'));
      if(d.members) members=d.members; if(d.transactions) transactions=d.transactions; if(d.looks) looks=d.looks; if(d.vendors) vendors=d.vendors; if(d.events) events=d.events; if(d.recurring) recurring=d.recurring; if(d.goal) budgetGoal=d.goal; if(d.options) SafeStorage.setItem('mn_options', JSON.stringify(d.options));
      persistMembers(); persistTransactions(); persistLooks(); persistVendors(); persistEvents(); persistRecurring(); SafeStorage.setItem('mn_goal', JSON.stringify(budgetGoal)); renderAll(); showToast('Backup restored');
    }catch(e){ showToast('Invalid backup file'); } }; r.readAsText(file);
  }
  function clearAllData(){ if(!confirm('Delete all local data?')) return; ['mn_members','mn_transactions','mn_looks','mn_vendors','mn_events','mn_recurring','mn_goal','mn_options'].forEach(SafeStorage.removeItem); location.reload(); }

  // Looks
  let looks=JSON.parse(SafeStorage.getItem('mn_looks')||'[]'); function persistLooks(){ SafeStorage.setItem('mn_looks', JSON.stringify(looks)); }
  function addLook(){ const title=document.getElementById('look-title').value.trim(); const notes=document.getElementById('look-notes').value.trim(); const items=[1,2,3,4].map(i=>document.getElementById('look-item-'+i).value.trim()).filter(Boolean); if(!title){ showToast('Enter look name'); return; } looks.unshift({ id:crypto.randomUUID(), title, notes, items, done:[] }); persistLooks(); renderLooks(); document.getElementById('look-title').value=''; document.getElementById('look-notes').value=''; [1,2,3,4].forEach(i=>document.getElementById('look-item-'+i).value=''); showToast('Look added'); }
  function toggleLookItem(lookId,item){ const l=looks.find(x=>x.id===lookId); if(!l) return; const i=l.done.indexOf(item); if(i>=0) l.done.splice(i,1); else l.done.push(item); persistLooks(); renderLooks(); }
  function removeLook(id){ looks=looks.filter(l=>l.id!==id); persistLooks(); renderLooks(); showToast('Look removed'); }
  function renderLooks(){ const list=document.getElementById('looks-list'); if(!looks.length){ list.innerHTML='<p class="text-sm text-brand-text-muted">No custom looks yet.</p>'; return; } list.innerHTML=looks.map(l=>`<div class="bg-brand-gray rounded-xl border border-brand-gold/30 p-4"><div class="flex justify-between items-start"><div><h4 class="font-cinzel text-lg text-white font-bold">${escapeHTML(l.title)}</h4>${l.notes?`<p class="text-sm text-brand-text-muted mt-1">${escapeHTML(l.notes)}</p>`:''}</div><button class="text-red-400 hover:underline text-sm" onclick='removeLook("${l.id}")'>Remove</button></div>${l.items?.length?`<ul class="mt-3 space-y-2 text-sm">${l.items.map(it=>{ const c=l.done?.includes(it); return `<li class="flex items-center"><button class="${c?'text-brand-gold':'text-brand-text-muted'} mr-3" onclick='toggleLookItem("${l.id}", ${JSON.stringify(it)})'>${c?'‚òëÔ∏è':'‚¨ú'}</button><span class="${c?'line-through text-brand-text-muted':''}">${escapeHTML(it)}</span></li>`; }).join('')}</ul>`:''}</div>`).join(''); }
  renderLooks();

  // Onboarding
  const onboarding=document.getElementById('onboarding'); const stepsWrap=document.getElementById('onboarding-steps'); const btnOnboarding=document.getElementById('btn-onboarding');
  let obStep=0; const steps=[ {title:'CRM',text:'Manage members, attendance, dues and roles.'}, {title:'Finances',text:'Categories, recurring, budget goals and analytics.'}, {title:'Events',text:'Plan events, collect RSVP and export .ics.'}, {title:'Reports',text:'Charts, monthly totals, CSV/JSON export and print.'}, {title:'Settings',text:'Currency, theme, backups and privacy.'} ];
  function startOnboarding(){ onboarding.classList.remove('hidden'); onboarding.classList.add('flex'); obStep=0; renderOnboarding(); }
  function endOnboarding(){ onboarding.classList.add('hidden'); onboarding.classList.remove('flex'); setOption('onboarded', true); }
  function onboardingPrev(){ if(obStep>0){ obStep--; renderOnboarding(); } }
  function onboardingNext(){ if(obStep<steps.length-1){ obStep++; renderOnboarding(); } else endOnboarding(); }
  function renderOnboarding(){ const s=steps[obStep]; stepsWrap.innerHTML=`<div class="bg-brand-black/40 border border-brand-gold/20 rounded-xl p-3"><div class="font-cinzel text-lg text-white">${escapeHTML(s.title)}</div><div class="text-sm text-brand-text-muted mt-1">${escapeHTML(s.text)}</div></div><div class="text-xs text-brand-text-muted">Step ${obStep+1} of ${steps.length}</div>`; if(s.title==='CRM') changeTab(0); if(s.title==='Finances') changeTab(1); if(s.title==='Events') changeTab(4); if(s.title==='Reports') changeTab(5); }
  btnOnboarding.addEventListener('click', startOnboarding);
  if(!getOption('onboarded')) setTimeout(startOnboarding, 600);

  // Menu tip
  document.getElementById('menu-btn').addEventListener('click', ()=>{ sidePanel.style.transform='translateX(0)'; });

  // Render all
  function renderAll(){ renderMembers(); renderTransactions(); renderRecurring(); renderEvents(); renderReports(); }
  initOptionsUI(); renderTransactions(); renderEvents(); renderReports();
</script>


</body></html>
