<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Mafia Nostra Clubbook</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        container: { center: true, padding: { DEFAULT: '1rem', md: '1.25rem', lg: '1.5rem' } },
        extend: {
          colors: {
            "brand-black": "#121212",
            "brand-gray": "#1E1E1E",
            "brand-gold": { "light": "#FDE08D", "DEFAULT": "#DF9B2D", "dark": "#AB7A22" },
            "brand-text": "#E0E0E0",
            "brand-text-muted": "#9A9A9A"
          },
          maxWidth: {
            'phone': '480px',
            'tablet': '1024px',
            'wide': '1280px'
          },
          screens: {
            xs: '380px',
            ipad: '768px',
            ipadl: '1024px'
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&amp;family=Cinzel:wght@600;700&amp;display=swap">
  <style>
    :root { color-scheme: dark; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .font-cinzel { font-family: 'Cinzel', serif; }

    .gold-gradient-text {
      background: linear-gradient(180deg, #FDE08D 0%, #DF9B2D 100%);
      -webkit-background-clip: text; background-clip: text;
      -webkit-text-fill-color: transparent; color: transparent;
    }
    .gold-gradient-bg { background: linear-gradient(180deg, #FDE08D 0%, #DF9B2D 100%); }
    .tab-active { color: #FDE08D !important; border-bottom-color: #DF9B2D !important; }

    /* Inputs consistent, with safe icon layer that never overlaps text */
    .input {
      width: 100%;
      background-color: #1E1E1E;
      color: #E0E0E0;
      border: 1.5px solid rgba(223,155,45,0.45);
      border-radius: 0.9rem;
      padding: 0.70rem 0.95rem;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
      appearance: none; /* prevent native arrows from breaking layout */
      -webkit-appearance: none;
      -moz-appearance: none;
    }
    .input::placeholder { color: #9A9A9A; }
    .input:focus {
      border-color: #DF9B2D;
      box-shadow: 0 0 0 3px rgba(223,155,45,0.15), inset 0 1px 0 rgba(255,255,255,0.05);
      background-color: #1C1C1C;
    }

    /* Icon wrapper uses a separate absolute span; we reserve padding with input-with-icon */
    .icon-left {
      position: absolute; inset-inline-start: 0.7rem; top: 50%; transform: translateY(-50%);
      color: #C9AE78; font-size: 0.95rem; pointer-events: none; line-height: 1;
      display: inline-flex; align-items: center; justify-content: center;
      width: 1.2rem; height: 1.2rem; border-radius: 0.4rem; background: rgba(255,255,255,0.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }
    .input-with-icon { padding-inline-start: 2.6rem; }

    /* Right caret for selects (custom), ensures no overlay */
    .select-wrap { position: relative; }
    .select-wrap::after {
      content: "‚ñæ";
      position: absolute; inset-inline-end: 0.7rem; top: 50%; transform: translateY(-50%);
      color: #C9AE78; font-size: 0.9rem; pointer-events: none;
      background: transparent;
    }

    /* Buttons */
    .btn-gold {
      background: #DF9B2D; color: #121212; font-weight: 700;
      padding: 0.6rem 1rem; border-radius: 0.75rem; font-size: 0.9rem;
      transition: filter .15s ease, transform .05s ease; white-space: nowrap;
    }
    .btn-gold:hover { filter: brightness(1.05); }
    .btn-gold:active { transform: translateY(1px); }
    .btn-ghost {
      background: #1E1E1E; border: 1px solid rgba(223,155,45,0.35);
      color: #E0E0E0; padding: 0.6rem 1rem; border-radius: 0.75rem; font-size: 0.9rem;
      white-space: nowrap; transition: border-color .15s ease, filter .15s ease;
    }
    .btn-ghost:hover { border-color: #DF9B2D; filter: brightness(1.03); }

    .safe-pad {
      padding-top: max(env(safe-area-inset-top), 0);
      padding-bottom: max(env(safe-area-inset-bottom), 0);
    }

    ::-webkit-scrollbar { display: none; }
    html, body { -ms-overflow-style: none; scrollbar-width: none; }

    /* Full-bleed layout rails and content width */
    .rail {
      min-height: 100svh;
      display: grid;
      grid-template-columns: 1fr min(100%, 960px) 1fr; /* center column wide enough for iPad */
    }
    .rail > * { grid-column: 2; }

    /* Cards hover for trackpads */
    @media (hover:hover) {
      .card:hover { border-color: rgba(223,155,45,0.6); }
    }

    /* Dense grid on very wide tablets/desktops for members */
    @media (min-width: 1024px) {
      #members-list.grid-dense {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.9rem;
      }
    }
  </style>
  <script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>
<body class="bg-brand-black text-brand-text safe-pad">
<div id="app" class="rail">

  <!-- Header -->
  <header class="w-full bg-brand-gray/50 backdrop-blur-sm sticky top-0 z-50 border-b border-brand-gold/20">
    <div class="px-4 md:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-md border border-brand-gold/40 flex items-center justify-center text-brand-gold text-base">‚â°</div>
        <h1 class="font-cinzel text-xl md:text-2xl tracking-wider gold-gradient-text font-bold">MAFIA NOSTRA</h1>
      </div>
      <!-- Right spacer -->
      <div style="width:2rem;height:2rem"></div>
    </div>

    <!-- Tabs -->
    <nav class="bg-brand-gray">
      <div class="flex overflow-x-auto px-2 md:px-6">
        <button onclick="changeTab(0)" class="tab-button py-3 px-4 text-xs xs:text-sm md:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold tab-active">CRM</button>
        <button onclick="changeTab(1)" class="tab-button py-3 px-4 text-xs xs:text-sm md:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">FINANCES</button>
        <button onclick="changeTab(2)" class="tab-button py-3 px-4 text-xs xs:text-sm md:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">DRESS CODE</button>
        <button onclick="changeTab(3)" class="tab-button py-3 px-4 text-xs xs:text-sm md:text-sm font-bold border-b-2 border-transparent text-brand-text-muted hover:text-brand-gold">MARKET</button>
      </div>
    </nav>
  </header>

  <!-- Main -->
  <main class="w-full px-4 md:px-6 pb-28 pt-4">

    <!-- CRM -->
    <section id="crm-tab" class="tab-panel space-y-4">
      <!-- Search -->
      <div class="relative">
        <span class="icon-left" aria-hidden="true">üîé</span>
        <input id="member-search" type="text" placeholder="Search members..." class="input input-with-icon">
        <div class="flex items-center gap-2 mt-3 flex-wrap">
          <button class="btn-gold" onclick="openMemberModal()">+ Add Member</button>
          <button class="btn-ghost" onclick="exportMembersCSV()">Export CSV</button>
        </div>
      </div>

      <!-- Filters (icons will never overlap thanks to reserved padding and custom caret) -->
      <div class="grid grid-cols-1 xs:grid-cols-3 gap-2">
        <div class="relative select-wrap">
          <span class="icon-left" aria-hidden="true">üë§</span>
          <select id="filter-role" class="input input-with-icon" onchange="applyMemberFilters()">
            <option value="">All Roles</option>
            <option value="DON">Don</option>
            <option value="CONSIGLIERE">Consigliere</option>
            <option value="ASSOCIATO">Associato</option>
          </select>
        </div>
        <div class="relative select-wrap">
          <span class="icon-left" aria-hidden="true">üí≥</span>
          <select id="filter-dues" class="input input-with-icon" onchange="applyMemberFilters()">
            <option value="">All Dues</option>
            <option value="Paid">Paid</option>
            <option value="Overdue">Overdue</option>
          </select>
        </div>
        <div class="relative select-wrap">
          <span class="icon-left" aria-hidden="true">‚ÜïÔ∏è</span>
          <select id="sort-by" class="input input-with-icon" onchange="applyMemberFilters()">
            <option value="name">Sort: Name</option>
            <option value="attendance">Sort: Attendance</option>
            <option value="loyalty">Sort: Loyalty</option>
          </select>
        </div>
      </div>

      <!-- Members -->
      <div id="members-list" class="space-y-3 ipadl:grid-dense"></div>
    </section>

    <!-- Finances -->
    <section id="finances-tab" class="tab-panel hidden space-y-4">
      <div class="bg-brand-gray p-6 rounded-xl border border-brand-gold/30 text-center">
        <h3 class="font-cinzel text-sm text-brand-text-muted tracking-widest">CLUB BUDGET</h3>
        <p id="budget-amount" class="text-4xl font-bold gold-gradient-text my-2">$0</p>
        <div class="h-2 w-full bg-brand-black rounded-full mt-2">
          <div id="budget-progress" class="h-2 gold-gradient-bg rounded-full" style="width: 0%;"></div>
        </div>
        <div class="mt-4 grid grid-cols-3 gap-2 text-xs">
          <div class="bg-brand-black/50 rounded p-2">
            <p class="text-brand-text-muted">Income</p>
            <p id="income-sum" class="font-bold text-green-400">+$0</p>
          </div>
          <div class="bg-brand-black/50 rounded p-2">
            <p class="text-brand-text-muted">Expenses</p>
            <p id="expense-sum" class="font-bold text-red-500">-$0</p>
          </div>
          <div class="bg-brand-black/50 rounded p-2">
            <p class="text-brand-text-muted">Net</p>
            <p id="net-sum" class="font-bold gold-gradient-text">$0</p>
          </div>
        </div>
      </div>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Add Transaction</h3>
        <div class="grid grid-cols-1 xs:grid-cols-2 gap-3">
          <div class="relative">
            <span class="icon-left" aria-hidden="true">üè∑Ô∏è</span>
            <input id="tx-title" class="input input-with-icon" placeholder="Title e.g. Venue Rental">
          </div>
          <div class="relative">
            <span class="icon-left" aria-hidden="true">$</span>
            <input id="tx-amount" type="number" step="0.01" class="input input-with-icon" placeholder="Amount e.g. 15000">
          </div>
          <div class="relative select-wrap">
            <span class="icon-left" aria-hidden="true">‚ÜîÔ∏è</span>
            <select id="tx-type" class="input input-with-icon">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
          <div class="relative">
            <span class="icon-left" aria-hidden="true">üìÖ</span>
            <input id="tx-date" type="date" class="input input-with-icon">
          </div>
        </div>
        <button class="btn-gold" onclick="addTransaction()">+ Add</button>
      </div>

      <h3 class="font-cinzel text-lg gold-gradient-text pt-2">Recent Transactions</h3>
      <div id="transactions-list" class="space-y-3"></div>
    </section>

    <!-- Dress Code -->
    <section id="dresscode-tab" class="tab-panel hidden space-y-4">
      <h2 class="font-cinzel text-xl gold-gradient-text">Style Guide: 1930s-1950s</h2>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Create Look</h3>
        <div class="relative">
          <span class="icon-left" aria-hidden="true">‚úçÔ∏è</span>
          <input id="look-title" class="input input-with-icon" placeholder="Look name e.g. The Don's Attire">
        </div>
        <div class="relative">
          <span class="icon-left" aria-hidden="true">üìù</span>
          <textarea id="look-notes" rows="3" class="input input-with-icon" placeholder="Notes: occasion, season, tips"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="relative"><span class="icon-left" aria-hidden="true">‚ñ™Ô∏è</span><input id="look-item-1" class="input input-with-icon" placeholder="Item 1 e.g. Pinstripe Suit"></div>
          <div class="relative"><span class="icon-left" aria-hidden="true">‚ñ™Ô∏è</span><input id="look-item-2" class="input input-with-icon" placeholder="Item 2 e.g. Fedora"></div>
          <div class="relative"><span class="icon-left" aria-hidden="true">‚ñ™Ô∏è</span><input id="look-item-3" class="input input-with-icon" placeholder="Item 3 e.g. Oxford Shoes"></div>
          <div class="relative"><span class="icon-left" aria-hidden="true">‚ñ™Ô∏è</span><input id="look-item-4" class="input input-with-icon" placeholder="Item 4 e.g. Pocket Square"></div>
        </div>
        <button class="btn-gold" onclick="addLook()">+ Add Look</button>
      </div>

      <div id="preset-looks" class="space-y-4">
        <div class="bg-brand-gray rounded-xl overflow-hidden border border-brand-gold/30">
          <img class="h-40 w-full object-cover" src="https://storage.googleapis.com/uxpilot-auth.appspot.com/f35626d113-11687626d1f337e3fff6.png" alt="Don look">
          <div class="p-4">
            <h3 class="font-cinzel text-lg font-bold text-white">The Don's Attire</h3>
            <p class="text-sm text-brand-text-muted mb-3">Essential for formal gatherings.</p>
            <ul class="text-sm space-y-2">
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Double-Breasted Pinstripe Suit</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Black Fedora Hat</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-text-muted mr-3"></span>Silk Pocket Square</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Polished Oxford Shoes</li>
            </ul>
          </div>
        </div>
        <div class="bg-brand-gray rounded-xl overflow-hidden border border-brand-gold/30">
          <img class="h-40 w-full object-cover" src="https://storage.googleapis.com/uxpilot-auth.appspot.com/62eea342d6-e93758d96a24d26670b1.png" alt="Associate casual">
          <div class="p-4">
            <h3 class="font-cinzel text-lg font-bold text-white">The Associate's Casual</h3>
            <p class="text-sm text-brand-text-muted mb-3">For day-to-day business.</p>
            <ul class="text-sm space-y-2">
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>High-Waisted Trousers</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-text-muted mr-3"></span>Silk Camp Collar Shirt</li>
              <li class="flex items-center"><span class="inline-block w-2 h-2 rounded-full bg-brand-gold mr-3"></span>Leather Suspenders</li>
            </ul>
          </div>
        </div>
      </div>

      <h3 class="font-cinzel text-lg gold-gradient-text">Your Looks</h3>
      <div id="looks-list" class="space-y-3"></div>
    </section>

    <!-- Marketplace -->
    <section id="marketplace-tab" class="tab-panel hidden space-y-4">
      <h2 class="font-cinzel text-xl gold-gradient-text">Approved Ateliers</h2>

      <div class="bg-brand-gray p-4 rounded-xl border border-brand-gold/30 space-y-3">
        <h3 class="font-cinzel text-lg gold-gradient-text">Add Vendor</h3>
        <div class="relative"><span class="icon-left" aria-hidden="true">üè™</span><input id="vendor-name" class="input input-with-icon" placeholder="Vendor name e.g. Giovanni's Fine Tailoring"></div>
        <div class="relative"><span class="icon-left" aria-hidden="true">üßµ</span><input id="vendor-service" class="input input-with-icon" placeholder="Services e.g. Bespoke Suits &amp; Alterations"></div>
        <div class="relative"><span class="icon-left" aria-hidden="true">üîó</span><input id="vendor-link" class="input input-with-icon" placeholder="Website or contact link (optional)"></div>
        <button class="btn-gold" onclick="addVendor()">+ Add Vendor</button>
      </div>

      <div id="vendors-list" class="space-y-3">
        <div class="flex items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/30 space-x-4">
          <div class="w-20 h-20 rounded-lg bg-brand-black/40 flex items-center justify-center text-brand-gold text-2xl">‚úÇÔ∏è</div>
          <div class="flex-1">
            <h3 class="font-bold text-white">Giovanni's Fine Tailoring</h3>
            <p class="text-sm text-brand-text-muted">Bespoke Suits &amp; Alterations</p>
            <span class="text-xs text-brand-gold hover:underline cursor-pointer" onclick="openVendor('Giovanni\'s Fine Tailoring')">View Services ‚Üí</span>
          </div>
        </div>
        <div class="flex items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/30 space-x-4">
          <div class="w-20 h-20 rounded-lg bg-brand-black/40 flex items-center justify-center text-brand-gold text-2xl">üëû</div>
          <div class="flex-1">
            <h3 class="font-bold text-white">Milano Shoe Shine &amp; Repair</h3>
            <p class="text-sm text-brand-text-muted">Leather Care &amp; Restoration</p>
            <span class="text-xs text-brand-gold hover:underline cursor-pointer" onclick="openVendor('Milano Shoe Shine &amp; Repair')">View Services ‚Üí</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Member Modal -->
  <div id="member-modal" class="fixed inset-0 bg-black/60 hidden items-end sm:items-center justify-center z-50">
    <div class="bg-brand-gray w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl border border-brand-gold/30 p-4">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-cinzel text-lg gold-gradient-text">Add/Edit Member</h3>
        <button class="text-brand-text-muted hover:text-brand-gold" onclick="closeMemberModal()">‚úï</button>
      </div>
      <div class="space-y-3">
        <div class="relative"><span class="icon-left" aria-hidden="true">ü™™</span><input id="m-name" class="input input-with-icon" placeholder="Full name"></div>
        <div class="relative select-wrap"><span class="icon-left" aria-hidden="true">‚ôî</span>
          <select id="m-role" class="input input-with-icon">
            <option value="DON">Don</option>
            <option value="CONSIGLIERE">Consigliere</option>
            <option value="ASSOCIATO">Associato</option>
          </select>
        </div>
        <div class="relative select-wrap"><span class="icon-left" aria-hidden="true">üíµ</span>
          <select id="m-dues" class="input input-with-icon">
            <option value="Paid">Dues: Paid</option>
            <option value="Overdue">Dues: Overdue</option>
          </select>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="relative"><span class="icon-left" aria-hidden="true">‚úÖ</span><input id="m-att" type="number" min="0" max="100" class="input input-with-icon" placeholder="Attendance %"></div>
          <div class="relative"><span class="icon-left" aria-hidden="true">‚≠ê</span><input id="m-loy" type="number" min="0" max="5" class="input input-with-icon" placeholder="Loyalty 0-5"></div>
        </div>
        <div class="relative"><span class="icon-left" aria-hidden="true">üñºÔ∏è</span><input id="m-avatar" class="input input-with-icon" placeholder="Avatar URL (optional)"></div>
      </div>
      <div class="flex justify-between items-center mt-4">
        <button class="btn-ghost" onclick="deleteMember()">Delete</button>
        <button class="btn-gold" onclick="saveMember()">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-brand-gray border border-brand-gold/30 text-brand-text px-4 py-2 rounded-lg hidden z-50"></div>
</div>

<script>
  // SafeStorage to avoid sandbox localStorage errors
  const SafeStorage = (() => {
    let memoryStore = {};
    const hasLocal = (() => {
      try { const k='__t'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; } catch(e){ return false; }
    })();
    function getItem(k){ return hasLocal ? localStorage.getItem(k) : (Object.prototype.hasOwnProperty.call(memoryStore,k)? memoryStore[k] : null); }
    function setItem(k,v){ return hasLocal ? localStorage.setItem(k,v) : (memoryStore[k]=v); }
    function removeItem(k){ return hasLocal ? localStorage.removeItem(k) : delete memoryStore[k]; }
    return { getItem, setItem, removeItem, hasLocal };
  })();

  // Tabs
  const tabs = document.querySelectorAll('.tab-button');
  const panels = document.querySelectorAll('.tab-panel');
  function changeTab(i){
    tabs.forEach((t,idx)=>t.classList.toggle('tab-active', idx===i));
    panels.forEach((p,idx)=>p.classList.toggle('hidden', idx!==i));
    SafeStorage.setItem('mn_active_tab', String(i));
  }
  const savedTab = Number(SafeStorage.getItem('mn_active_tab'));
  if (!Number.isNaN(savedTab)) setTimeout(()=>changeTab(savedTab), 0);

  // Toast
  function showToast(msg){
    const t=document.getElementById('toast');
    t.textContent=msg; t.classList.remove('hidden');
    clearTimeout(showToast._t); showToast._t=setTimeout(()=>t.classList.add('hidden'),2200);
  }

  // CRM
  const membersListEl = document.getElementById('members-list');
  const searchEl = document.getElementById('member-search');
  const filterRoleEl = document.getElementById('filter-role');
  const filterDuesEl = document.getElementById('filter-dues');
  const sortByEl = document.getElementById('sort-by');

  let members = JSON.parse(SafeStorage.getItem('mn_members') || '[]');
  let editingId = null;

  if (members.length===0){
    members = [
      { id: crypto.randomUUID(), name: "Don Vito Corleone", role: "DON", dues: "Paid", attendance: 100, loyalty: 5, avatar: "https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-3.jpg" },
      { id: crypto.randomUUID(), name: "Peter Clemenza", role: "ASSOCIATO", dues: "Overdue", attendance: 72, loyalty: 4, avatar: "https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-4.jpg" },
      { id: crypto.randomUUID(), name: "Salvatore Tessio", role: "ASSOCIATO", dues: "Paid", attendance: 88, loyalty: 4, avatar: "https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-9.jpg" },
      { id: crypto.randomUUID(), name: "Tom Hagen", role: "CONSIGLIERE", dues: "Paid", attendance: 96, loyalty: 5, avatar: "https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-8.jpg" }
    ];
    persistMembers();
  }
  function persistMembers(){ SafeStorage.setItem('mn_members', JSON.stringify(members)); }

  function loyaltyStars(n){ const full='‚òÖ', empty='‚òÜ'; return Array.from({length:5},(_,i)=> i<n? `<span class="text-brand-gold">${full}</span>`:`<span class="text-brand-gold/50">${empty}</span>`).join(''); }

  function renderMembers(){
    const q=(searchEl.value||'').toLowerCase(), role=filterRoleEl.value, dues=filterDuesEl.value, sortBy=sortByEl.value;
    let arr = members.filter(m => m.name.toLowerCase().includes(q) && (!role || m.role===role) && (!dues || m.dues===dues));
    arr.sort((a,b)=> sortBy==='name'?a.name.localeCompare(b.name): sortBy==='attendance'?(b.attendance||0)-(a.attendance||0) : (b.loyalty||0)-(a.loyalty||0));
    membersListEl.innerHTML = arr.map(m=>`
      <div class="card bg-brand-gray p-4 rounded-xl border ${m.role==='DON'?'border-brand-gold/50 shadow-lg shadow-brand-gold/10':'border-brand-gold/30'}">
        <div class="flex items-center gap-4">
          <img src="${m.avatar || 'https://storage.googleapis.com/uxpilot-auth.appspot.com/avatars/avatar-2.jpg'}" class="w-16 h-16 rounded-full border-2 ${m.role==='DON'?'border-brand-gold':'border-brand-gold-dark'}" alt="${m.name}">
          <div class="flex-1 min-w-0">
            <h3 class="text-base md:text-lg font-bold text-white truncate">${m.name}</h3>
            <p class="font-cinzel text-xs md:text-sm ${m.role==='DON'?'gold-gradient-text font-semibold':'text-brand-gold'}">${m.role}</p>
            <p class="text-[11px] md:text-xs text-brand-text-muted mt-0.5">Dues: <span class="${m.dues==='Paid'?'text-green-400':'text-red-500'} font-semibold">${m.dues}</span></p>
            <div class="mt-2 text-[11px] md:text-xs text-brand-text-muted flex justify-between">
              <span>Attendance: ${m.attendance || 0}%</span>
              <span>Loyalty: ${loyaltyStars(m.loyalty || 0)}</span>
            </div>
          </div>
          <div class="flex flex-col items-end gap-2 text-sm">
            <button class="text-brand-gold hover:underline" onclick='openMemberModal(${JSON.stringify(m.id)})'>Edit</button>
            <button class="text-red-400 hover:underline" onclick='confirmDelete("${m.id}")'>Remove</button>
          </div>
        </div>
      </div>
    `).join('');
  }
  function applyMemberFilters(){ renderMembers(); }
  searchEl.addEventListener('input', renderMembers);
  renderMembers();

  // Modal
  const modal = document.getElementById('member-modal');
  const mName = document.getElementById('m-name');
  const mRole = document.getElementById('m-role');
  const mDues = document.getElementById('m-dues');
  const mAtt  = document.getElementById('m-att');
  const mLoy  = document.getElementById('m-loy');
  const mAv   = document.getElementById('m-avatar');

  function openMemberModal(id=null){
    editingId=id;
    if(id){
      const m=members.find(x=>x.id===id); if(!m) return;
      mName.value=m.name||''; mRole.value=m.role||'ASSOCIATO'; mDues.value=m.dues||'Paid';
      mAtt.value=m.attendance??''; mLoy.value=m.loyalty??''; mAv.value=m.avatar||'';
    } else { mName.value=''; mRole.value='ASSOCIATO'; mDues.value='Paid'; mAtt.value=''; mLoy.value=''; mAv.value=''; }
    modal.classList.remove('hidden'); modal.classList.add('flex');
  }
  function closeMemberModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }
  function saveMember(){
    const payload={ name:mName.value.trim(), role:mRole.value, dues:mDues.value,
      attendance:Number(mAtt.value||0), loyalty:Math.min(5, Math.max(0, Number(mLoy.value||0))), avatar:mAv.value.trim() };
    if(!payload.name){ showToast('Enter member name'); return; }
    if(editingId){ const i=members.findIndex(x=>x.id===editingId); if(i>=0) members[i]={...members[i],...payload}; showToast('Member updated'); }
    else { members.push({ id: crypto.randomUUID(), ...payload }); showToast('Member added'); }
    persistMembers(); renderMembers(); closeMemberModal();
  }
  function confirmDelete(id){
    if(confirm('Remove this member?')){ members = members.filter(m=>m.id!==id); persistMembers(); renderMembers(); showToast('Member removed'); }
  }
  function deleteMember(){ if(!editingId){ showToast('Nothing to delete'); return; } confirmDelete(editingId); closeMemberModal(); }
  function exportMembersCSV(){
    const header=['Name','Role','Dues','Attendance','Loyalty','Avatar'];
    const rows=members.map(m=>[m.name,m.role,m.dues,m.attendance,m.loyalty,m.avatar||'']);
    const csv=[header,...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='members.csv'; document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url); showToast('Exported members.csv');
  }

  // Finances
  let transactions = JSON.parse(SafeStorage.getItem('mn_transactions') || '[]');
  if(transactions.length===0){
    transactions=[
      { id: crypto.randomUUID(), title:"Venue Rental: The Venetian", amount:-15000, type:"expense", date:"2025-10-01" },
      { id: crypto.randomUUID(), title:"Member Dues - Q4", amount:50000, type:"income", date:"2025-09-30" },
      { id: crypto.randomUUID(), title:"Prize Pool Contribution", amount:-5000, type:"expense", date:"2025-09-28" }
    ];
    persistTransactions();
  }
  function persistTransactions(){ SafeStorage.setItem('mn_transactions', JSON.stringify(transactions)); }
  function addTransaction(){
    const title=document.getElementById('tx-title').value.trim();
    const amount=Number(document.getElementById('tx-amount').value);
    const type=document.getElementById('tx-type').value;
    const date=document.getElementById('tx-date').value || new Date().toISOString().slice(0,10);
    if(!title || isNaN(amount) || amount===0){ showToast('Enter valid title and amount'); return; }
    const signed= type==='expense' ? -Math.abs(amount) : Math.abs(amount);
    transactions.unshift({ id: crypto.randomUUID(), title, amount: signed, type, date });
    persistTransactions(); renderTransactions();
    document.getElementById('tx-title').value=''; document.getElementById('tx-amount').value=''; showToast('Transaction added');
  }
  function deleteTransaction(id){ transactions = transactions.filter(t=>t.id!==id); persistTransactions(); renderTransactions(); showToast('Transaction removed'); }
  function renderTransactions(){
    const list=document.getElementById('transactions-list');
    list.innerHTML = transactions.map(t=>`
      <div class="flex justify-between items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/20">
        <div>
          <p class="font-bold text-white">${t.title}</p>
          <p class="text-xs text-brand-text-muted">${new Date(t.date).toLocaleDateString()}</p>
        </div>
        <div class="flex items-center gap-3">
          <p class="font-bold ${t.amount>=0?'text-green-400':'text-red-500'}">${t.amount>=0?'+':''}$${Math.abs(t.amount).toLocaleString()}</p>
          <button class="text-red-400 hover:underline text-sm" onclick='deleteTransaction("${t.id}")'>Remove</button>
        </div>
      </div>
    `).join('');
    const income=transactions.filter(t=>t.amount>0).reduce((s,t)=>s+t.amount,0);
    const expense=transactions.filter(t=>t.amount<0).reduce((s,t)=>s+t.amount,0);
    const net=income+expense; const target=Math.max(1,income);
    document.getElementById('income-sum').textContent = `+$${income.toLocaleString()}`;
    document.getElementById('expense-sum').textContent = `-$${Math.abs(expense).toLocaleString()}`;
    document.getElementById('net-sum').textContent = `$${net.toLocaleString()}`;
    document.getElementById('budget-amount').textContent = `$${(income+expense).toLocaleString()}`;
    document.getElementById('budget-progress').style.width = `${Math.min(100,Math.round((income/target)*100))}%`;
  }
  renderTransactions();

  // Dress Code
  let looks = JSON.parse(SafeStorage.getItem('mn_looks') || '[]');
  function persistLooks(){ SafeStorage.setItem('mn_looks', JSON.stringify(looks)); }
  function addLook(){
    const title=document.getElementById('look-title').value.trim();
    const notes=document.getElementById('look-notes').value.trim();
    const items=[1,2,3,4].map(i=>document.getElementById('look-item-'+i).value.trim()).filter(Boolean);
    if(!title){ showToast('Enter look name'); return; }
    looks.unshift({ id: crypto.randomUUID(), title, notes, items, done: [] });
    persistLooks(); renderLooks();
    document.getElementById('look-title').value=''; document.getElementById('look-notes').value='';
    [1,2,3,4].forEach(i=> document.getElementById('look-item-'+i).value=''); showToast('Look added');
  }
  function toggleLookItem(lookId,item){
    const l=looks.find(x=>x.id===lookId); if(!l) return;
    const i=l.done.indexOf(item); if(i>=0) l.done.splice(i,1); else l.done.push(item);
    persistLooks(); renderLooks();
  }
  function removeLook(id){ looks = looks.filter(l=>l.id!==id); persistLooks(); renderLooks(); showToast('Look removed'); }
  function renderLooks(){
    const list=document.getElementById('looks-list');
    if(!looks.length){ list.innerHTML=`<p class="text-sm text-brand-text-muted">No custom looks yet.</p>`; return; }
    list.innerHTML = looks.map(l=>`
      <div class="bg-brand-gray rounded-xl border border-brand-gold/30 p-4">
        <div class="flex justify-between items-start">
          <div>
            <h4 class="font-cinzel text-lg text-white font-bold">${l.title}</h4>
            ${l.notes?`<p class="text-sm text-brand-text-muted mt-1">${l.notes}</p>`:''}
          </div>
          <button class="text-red-400 hover:underline text-sm" onclick='removeLook("${l.id}")'>Remove</button>
        </div>
        ${l.items?.length?`<ul class="mt-3 space-y-2 text-sm">${l.items.map(it=>{
          const c=l.done?.includes(it);
          return `<li class="flex items-center">
            <button class="${c?'text-brand-gold':'text-brand-text-muted'} mr-3" onclick='toggleLookItem("${l.id}", ${JSON.stringify(it)})'>${c?'‚òëÔ∏è':'‚¨ú'}</button>
            <span class="${c?'line-through text-brand-text-muted':''}">${it}</span>
          </li>`;
        }).join('')}</ul>`:''}
      </div>
    `).join('');
  }
  renderLooks();

  // Marketplace
  let vendors = JSON.parse(SafeStorage.getItem('mn_vendors') || '[]');
  function persistVendors(){ SafeStorage.setItem('mn_vendors', JSON.stringify(vendors)); }
  function addVendor(){
    const name=document.getElementById('vendor-name').value.trim();
    const service=document.getElementById('vendor-service').value.trim();
    const link=document.getElementById('vendor-link').value.trim();
    if(!name || !service){ showToast('Enter vendor name and service'); return; }
    vendors.unshift({ id: crypto.randomUUID(), name, service, link });
    persistVendors(); renderVendors();
    document.getElementById('vendor-name').value=''; document.getElementById('vendor-service').value=''; document.getElementById('vendor-link').value='';
    showToast('Vendor added');
  }
  function removeVendor(id){ vendors = vendors.filter(v=>v.id!==id); persistVendors(); renderVendors(); showToast('Vendor removed'); }
  function openVendor(name){ showToast(`Opening ${name}...`); }
  function renderVendors(){
    const wrap=document.getElementById('vendors-list');
    let container=document.getElementById('vendors-dynamic');
    if(!container){ container=document.createElement('div'); container.id='vendors-dynamic'; wrap.appendChild(container); }
    container.innerHTML = vendors.map(v=>`
      <div class="flex items-center bg-brand-gray p-3 rounded-lg border border-brand-gold/30 space-x-4" data-dynamic="true">
        <div class="w-20 h-20 rounded-lg flex items-center justify-center bg-brand-black/40 text-brand-gold text-2xl">üßµ</div>
        <div class="flex-1">
          <h3 class="font-bold text-white">${v.name}</h3>
          <p class="text-sm text-brand-text-muted">${v.service}</p>
          <div class="flex items-center gap-3 mt-1">
            ${v.link?`<a href="${v.link}" target="_blank" class="text-xs text-brand-gold hover:underline">Open Link ‚Üó</a>`:''}
            <button class="text-xs text-red-400 hover:underline" onclick='removeVendor("${v.id}")'>Remove</button>
          </div>
        </div>
      </div>
    `).join('');
  }
  renderVendors();
</script>


</body></html>
